name: NGINX App Protect DevSecOps
run-name: Triggered by ${{ github.actor }} üöÄ
on: [push]
jobs:
  Compile-App-Protect-Policies:
    runs-on: self-hosted
    steps:
      - run: |
          rm -rf .compiled/
          mkdir -p .compiled/policies
          mkdir -p .compiled/logs
      - run: echo "Compiling App Protect policies..."
      - run: |
          for file in ${{ github.workspace }}/policies/*; do \
            file_basename=$(basename $file .json); \
            /opt/app_protect/bin/apcompile -include-source -full-export \
              -g ${{ github.workspace }}/global_settings.json \
              -p ${{ github.workspace }}/policies/$file_basename.json \
              -o ${{ github.workspace }}/.compiled/policies/$file_basename.tgz; \
          done
      - run: echo "Compiling log policies..."
      - run: |
          for file in ${{ github.workspace }}/logs/*; do \
            file_basename=$(basename $file .json); \
            /opt/app_protect/bin/apcompile \
              -l ${{ github.workspace }}/logs/$file_basename.json \
              -o ${{ github.workspace }}/.compiled/logs/$file_basename.tgz; \
          done
  Publish-Policies:
    needs: Compile-App-Protect-Policies
    runs-on: self-hosted
    steps:
      - run: |
          NIC_PODS=$(kubectl -n nginx-ingress-public get pods -l app.kubernetes.io/instance=nginx-ingress-public -o jsonpath='{.items[*].metadata.name}')
          echo "Found pod $NIC_PODS"
          echo "ALL_NIC_PODS=$NIC_PODS" >> "$GITHUB_ENV"
          echo "NIC_POD=$(echo $NIC_PODS | cut -d' ' -f1)" >> "$GITHUB_ENV"
      - run: echo "Publishing App Protect bundles..."
      - run: |
          for file in ${{ github.workspace }}/policies/*; do \
            kubectl -n nginx-ingress-public cp $file $NIC_POD:/etc/app_protect/bundles/$(basename $file) \
          done
      - run: echo "Publishing log bundles..."
      - run: |
          for file in ${{ github.workspace }}/logs/*; do \
            kubectl -n nginx-ingress-public cp $file $NIC_POD:/etc/app_protect/bundles/$(basename $file) \
          done
      - run: echo "Reloading App Protect..."
      - run: |
          for pod in $ALL_NIC_PODS; do
            echo "Running command on $pod"
            kubectl -n nginx-ingress-public exec $pod -- /opt/app_protect/bin/apreload
          done
      - run: |
          echo "Negative test, expecting to fail"
          NIC_POD=$(kubectl -n nginx-ingress-public get pods -l app.kubernetes.io/instance=nginx-ingress-123 -o jsonpath='{.items[0].metadata.name}')
          echo "Is this going to run?"
      # - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      # - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      # - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      # - name: Check out repository code
      #   uses: actions/checkout@v4
      # - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      # - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."
      # - name: List files in the repository
      #   run: |
      #     ls ${{ github.workspace }}
      # - run: echo "üçè This job's status is ${{ job.status }}."
