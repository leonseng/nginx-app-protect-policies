name: NGINX App Protect DevSecOps
run-name: Triggered by ${{ github.actor }} ðŸš€
on: [push]
jobs:
  Compile-App-Protect-Policies:
    runs-on: self-hosted
    steps:
      - name: 'Cleanup build folder'
        run: |
          ls -la ./
          rm -rf ./* || true
          rm -rf ./.??* || true
          ls -la ./
      - name: Check out repository code
        uses: actions/checkout@v4
      - run: |
          echo $(pwd)
          echo ${{ github.workspace }}
          ls -la
      - run: echo "Compiling App Protect policies..."
      - run: |
          mkdir -p .compiled/ap
          for file in ${{ github.workspace }}/policies/app_protect/*; do \
            file_basename=$(basename $file .json); \
            /opt/app_protect/bin/apcompile -include-source -full-export \
              -g ${{ github.workspace }}/policies/global_settings.json \
              -p ${{ github.workspace }}/policies/app_protect/$file_basename.json \
              -o ${{ github.workspace }}/.compiled/ap/$file_basename.tgz; \
          done
      - run: echo "Compiling log policies..."
      - run: |
          mkdir -p .compiled/log
          for file in ${{ github.workspace }}/app_protect/log/*; do \
            file_basename=$(basename $file .json); \
            /opt/app_protect/bin/apcompile \
              -l ${{ github.workspace }}/app_protect/log/$file_basename.json \
              -o ${{ github.workspace }}/.compiled/log/$file_basename.tgz; \
          done
  Publish-Policies-To-NIC:
    needs: Compile-App-Protect-Policies
    runs-on: self-hosted
    steps:
      - run: cat ${{ github.workspace }}/.env >> $GITHUB_ENV
      - run: |
          NIC_PODS=$(kubectl -n $NIC_NAMESPACE get pods -l $NIC_LABEL_SELECTOR -o jsonpath='{.items[*].metadata.name}')
          echo "Found pod $NIC_PODS"
          echo "ALL_NIC_PODS=$NIC_PODS" >> "$GITHUB_ENV"
          echo "NIC_POD=$(echo $NIC_PODS | cut -d' ' -f1)" >> "$GITHUB_ENV"
      - run: echo "Publishing App Protect bundles..."
      - run: |
          kubectl -n $NIC_NAMESPACE exec $NIC_POD -- mkdir -p /etc/app_protect/bundles/ap
          for file in ${{ github.workspace }}/.compiled/ap/*; do \
            kubectl -n $NIC_NAMESPACE cp $file $NIC_POD:/etc/app_protect/bundles/ap/$(basename $file); \
          done
      - run: echo "Publishing log bundles..."
      - run: |
          kubectl -n $NIC_NAMESPACE exec $NIC_POD -- mkdir -p /etc/app_protect/bundles/log
          for file in ${{ github.workspace }}/.compiled/log/*; do \
            kubectl -n $NIC_NAMESPACE cp $file $NIC_POD:/etc/app_protect/bundles/log/$(basename $file); \
          done
  Reload-App-Protect:
    needs: Publish-Policies-To-NIC
    runs-on: self-hosted
    steps:
      - run: cat ${{ github.workspace }}/.env >> $GITHUB_ENV
      - run: echo "Reloading App Protect..."
      - run: |
          for pod in $ALL_NIC_PODS; do \
            echo "Running command on $pod"; \
            kubectl -n $NIC_NAMESPACE exec $pod -- /opt/app_protect/bin/apreload; \
          done
